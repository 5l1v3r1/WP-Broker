import os
import sys
import time
import requests
from urllib.parse import urlparse

global TIMEOUT
TIMEOUT = 0

class color:
    PURPLE = '\033[95m'
    CYAN = '\033[96m'
    DARKCYAN = '\033[36m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
    END = '\033[0m'

def GOOD_WRITE(TEXT):
    print(color.GREEN+"    [+] "+color.END+TEXT)

def INFO_WRITE(TEXT):
    print(color.BLUE+"    [i] "+color.END+TEXT)

def ERROR_WRITE(TEXT):
    print(color.RED+"    [-] "+color.END+TEXT)

def WARNING_WRITE(TEXT):
    print(color.YELLOW+"    [!] "+color.END+TEXT)

def REQUEST(URL):
    global TIMEOUT
    VALID_REQUEST = False
    HEADERS = {
        "User-Agent": "Mozilla/5.0 (iPod; U; CPU iPhone OS 2_2 like Mac OS X; en-us) AppleWebKit/525.18.1 (KHTML, like Gecko) Version/3.1.1 Mobile/5G77a Safari/525.20",
    }
    try:
        RESPONCE = requests.post(URL, headers=HEADERS, allow_redirects=False)
        VALID_REQUEST = True
    except:
        WARNING_WRITE("Error at sending and receiving an HTTP(s) response, adding timeout of 1 second...")
        TIMEOUT = TIMEOUT + 1
        RESPONCE = ""
        pass
    if VALID_REQUEST == True:
        return RESPONCE.status_code
    return 900

def ScanPlugins(WEBSITE_TO_SCAN):
    PLUGIN_VULNERABILITY = {
    "/wp-admin/admin-ajax.php?action=revslider_show_image&img=../wp-config.php": ["WordPress CuckooTap Theme & eShop Arbitrary File Download", "http://goo.gl/QRlPLT", "Medium"],
    "/wp-admin/admin-ajax.php?action=kbslider_show_image&img=../wp-config.php": ["WordPress KenBurner Slider Arbitrary File Download","http://goo.gl/d7CXS9", "Medium"],
    "/wp-content/plugins/ck-and-syntaxhighlighter/ckfinder/ckfinder.html": ["WordPress CK / SyntaxHighLighter Arbitrary File Upload","http://goo.gl/Ws5ke4", "Critical"],
    "/wp-includes/js/plupload": ["WordPress JSP File Upload Cross-Site-Scripting","http://goo.gl/Uluyky", "Critical"],
    "/wp-content/themes/myband/": ["WordPress MyBand Theme Cross-Site-Scripting","http://goo.gl/dmuuaU", "Low"],
    "/wp-content/grand-media/": ["WordPress Gmedia Gallery 1.2.1 Shell Upload","http://goo.gl/u6L2xz", "Critical"],
    "/wp-admin/admin-ajax.php?action=revslider_show_image&img=../wp-config.php": ["WordPress Slider Revolution Responsive 4.1.4 File Download","http://goo.gl/zl9bxe", "Medium"],
    "/wp-content/plugins/Lead-Octopus-Power/lib/optin/optin_page.php": ["WordPress LeadOctopusPower SQL Injection","http://goo.gl/a3hAB2", "Medium"],
    "/wp-content/plugins/fbgorilla/game_play.php": ["WordPress FBGorilla SQL Injection","http://goo.gl/tuKbKc", "Medium"],
    "/wp-content/plugins/tidio-gallery/popup-insert-help.php": ["WordPress Tidio Gallery 1.1 XSS", "No Referrer", "Low"],
    "/wp-content/plugins/download-manager/wpdm-add-new-file.php": ["WordPress Download Manager 2.6.8 Shell Upload","http://goo.gl/N90axF", "Critical"] ,
    "/wp-content/plugins/Premium_Gallery_Manager/uploadify/uploadify.php": ["WordPress Premium Gallery Manager Shell Upload","http://goo.gl/agwDOu", "Critical"],
    "/wp-content/plugins/barclaycart/uploadify/uploadify.php": ["WordPress Barclaycart Shell Upload","http://goo.gl/4SFV2q", "Critical"],
    "/wp-content/plugins/page-flip-image-gallery/upload.php": ["WordPress Page Flip Image Gallery Shell Upload","http://goo.gl/Z1TkAJ", "Critical"],
    "/wp-content/plugins/dzs-videogallery/admin/dzsuploader/upload.php": ["WordPress dzs - videogallery Plugins Remote File Upload Vulnerability","http://goo.gl/hJzcYg", "Critical"],
    "/wp-content/plugins/wp-filemanager/incl/libfile.php?&path=../../&filename=wp-config.php&action=download": ["WordPress wp - FileManager File Download"," http://goo.gl/3D1oQ9", "Medium"],
    "/wp-content/plugins/user-meta/framework/helper/uploader.php": ["WordPress User Meta 1.1.1 Shell Upload","http:/goo.gl/zyU1qR", "Critical"],
    "/trunk/src/wp-includes/compat.php": ["Wordpress 3.9.1 pluggable.php CSRF vulnerability", "http://goo.gl/iL4uRs", "Medium"],
    "/wp-comments-post.php": ["Wordpress 3.9.1 - CSRF vulnerability | Very Common File May Be False Positive!", "http://goo.gl/XmlhhJ", "Medium"],
    "/wp-content/plugins/wp-filemanager/": ["wp-FileManager Download", "http://goo.gl/MvH4eU", "Medium"]}
    URL = ""
    DOMAIN = urlparse(WEBSITE_TO_SCAN)
    if DOMAIN.scheme == "https":
        URL = "https://"+DOMAIN.netloc
    elif DOMAIN.scheme == "http":
        URL = "http://"+DOMAIN.netloc
    GOOD_WRITE("Starting Vulnerable Plugin Scan ...")
    TOTAL_VULN_FOUND = 0
    for EXPLOIT_PATH,(EXPLOIT,PoC,SecurityLevel) in PLUGIN_VULNERABILITY.items():
        REQ = REQUEST(URL+EXPLOIT_PATH)
        if not REQ == 900:
            if not REQ == [400,401,404] and REQ == 200:
                TOTAL_VULN_FOUND = TOTAL_VULN_FOUND + 1
                GOOD_WRITE("Vulnerability Found =>")
                print("       - Exploit Path =>", EXPLOIT_PATH)
                print("       - Exploit Name =>", EXPLOIT)
                print("       - PoC / Referrer =>", PoC)
                if SecurityLevel == "Critical":
                    print("       - Security Level =>"+color.RED, SecurityLevel, color.END)
                if SecurityLevel == "High":
                    print("       - Security Level =>"+color.RED, SecurityLevel, color.END)
                if SecurityLevel == "Medium":
                    print("       - Security Level =>"+color.YELLOW, SecurityLevel, color.END)
                if SecurityLevel == "Low":
                    print("       - Security Level =>" + color.GREEN, SecurityLevel, color.END)
            else:
                WARNING_WRITE("Not Vulnerable => "+EXPLOIT)
        else:
            ERROR_WRITE("HTTP Error.")
    INFO_WRITE("Total Vulnerability Found: "+str(TOTAL_VULN_FOUND))
